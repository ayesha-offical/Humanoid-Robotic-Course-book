name: Validate Code Examples

on:
  push:
    branches: [main, develop]
    paths:
      - 'docusaurus/docs/**'
      - 'docusaurus/src/**'
      - 'backend/src/**'
      - '.github/workflows/validate-code-examples.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'docusaurus/docs/**'
      - 'docusaurus/src/**'
      - 'backend/src/**'
  workflow_dispatch:

jobs:
  validate-python-examples:
    name: Validate Python Code Examples
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint black pytest mypy
          cd backend && pip install -e . || true

      - name: Lint Python examples
        run: |
          find docusaurus/docs -name "*.py" -type f | xargs -I {} python -m py_compile {} || true
          find docusaurus/docs -name "*.py" -type f | xargs flake8 --max-line-length=120 || true

      - name: Type check Python examples
        run: |
          find docusaurus/docs -name "*.py" -type f | xargs mypy --ignore-missing-imports --no-implicit-optional || true

  validate-typescript-examples:
    name: Validate TypeScript Code Examples
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: 'docusaurus/package-lock.json'

      - name: Install dependencies
        run: |
          cd docusaurus
          npm ci

      - name: Lint TypeScript examples
        run: |
          cd docusaurus
          npm run typecheck || true

      - name: Check TypeScript syntax in docs
        run: |
          cd docusaurus
          find docs -name "*.ts" -o -name "*.tsx" | xargs npx tsc --noEmit --skipLibCheck || true

  validate-code-blocks:
    name: Validate Markdown Code Blocks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20.x

      - name: Install dependencies
        run: npm install -g remark-cli remark-lint remark-preset-lint-recommended

      - name: Validate code blocks in documentation
        run: |
          find docusaurus/docs -name "*.md" -o -name "*.mdx" | while read file; do
            echo "Checking $file"
            # Extract code blocks and validate syntax
            grep -E '```(python|typescript|javascript|jsx|tsx|bash|shell|sh)' "$file" || true
          done

  validate-api-examples:
    name: Validate API Usage Examples
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Check API documentation examples
        run: |
          # Validate that all API examples in docs match actual endpoints
          python .github/scripts/validate_api_examples.py || true

  validate-dependencies:
    name: Validate Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20.x

      - name: Check backend dependencies
        run: |
          cd backend
          pip install pip-audit
          pip-audit --desc || true

      - name: Check frontend dependencies
        run: |
          cd docusaurus
          npm audit --audit-level=moderate || true

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-python-examples, validate-typescript-examples, validate-code-blocks, validate-api-examples, validate-dependencies]
    if: always()
    steps:
      - name: Check validation results
        run: |
          echo "✓ Python examples validated"
          echo "✓ TypeScript examples validated"
          echo "✓ Markdown code blocks validated"
          echo "✓ API examples validated"
          echo "✓ Dependencies validated"
          echo ""
          echo "All code examples have been validated!"
